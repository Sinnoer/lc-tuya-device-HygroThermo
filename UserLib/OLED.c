/*
 * Copyright (c) 2006-2020, RT-Thread Development Team
 *
 * SPDX-License-Identifier: Apache-2.0
 *
 * Change Logs:
 * Date           Author       Notes
 * 2021-02-08     Sinnoer       the first version
 */
#include "include/OLED.h"
#define W4_OLED_PIN         GET_PIN(A, 12)     /* OLED -> PA12 */
#define W4_DC_PIN           GET_PIN(E, 4)      /* SDA -> PE4 */
#define W4_SCL_PIN          GET_PIN(E, 5)      /* SCL -> PE5 */
#define W4_SDA_PIN          GET_PIN(E, 6)      /* SDA -> PE6 */

#define W4_OLED_D_OUT       rt_pin_mode(W4_OLED_PIN, PIN_MODE_OUTPUT)
#define W4_DC_D_OUT         rt_pin_mode(W4_DC_PIN, PIN_MODE_OUTPUT)
#define W4_SCL_D_OUT        rt_pin_mode(W4_SCL_PIN, PIN_MODE_OUTPUT)
#define W4_SDA_D_OUT        rt_pin_mode(W4_SDA_PIN, PIN_MODE_OUTPUT)
#define W4C_DELAY           2

unsigned char show[95][8]=
{
 { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, /*" ",0*/
{ 0x00, 0x00, 0x00, 0x72, 0x22, 0x00, 0x00, 0x00 }, /*"!",1*/
{ 0x00, 0x20, 0x40, 0x00, 0x40, 0x40, 0x00, 0x00 }, /*""",2*/
{ 0x00, 0x04, 0x7C, 0x14, 0x14, 0x3E, 0x04, 0x00 }, /*"#",3*/
{ 0x00, 0x24, 0x56, 0x52, 0x2E, 0x2A, 0x24, 0x00 }, /*"$",4*/
{ 0x30, 0x4A, 0x4C, 0x38, 0x14, 0x2A, 0x0A, 0x04 }, /*"%",5*/
{ 0x04, 0x2A, 0x5A, 0x56, 0x22, 0x0E, 0x02, 0x02 }, /*"&",6*/
{ 0x00, 0x20, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00 }, /*"'",7*/
{ 0x00, 0x00, 0x00, 0x18, 0x24, 0x42, 0x01, 0x00 }, /*"(",8*/
{ 0x00, 0x01, 0x42, 0x3C, 0x00, 0x00, 0x00, 0x00 }, /*")",9*/
{ 0x00, 0x10, 0x18, 0x3C, 0x28, 0x18, 0x10, 0x00 }, /*"*",10*/
{ 0x00, 0x00, 0x08, 0x08, 0x18, 0x08, 0x08, 0x00 }, /*"+",11*/
{ 0x00, 0x02, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00 }, /*",",12*/
{ 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x00 }, /*"-",13*/
{ 0x00, 0x02, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00 }, /*".",14*/
{ 0x00, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x00 }, /*"/",15*/
{ 0x00, 0x3C, 0x22, 0x42, 0x42, 0x22, 0x3C, 0x00 }, /*"0",16*/
{ 0x00, 0x00, 0x00, 0x22, 0x7E, 0x00, 0x00, 0x00 }, /*"1",17*/
{ 0x00, 0x22, 0x46, 0x46, 0x4A, 0x52, 0x32, 0x00 }, /*"2",18*/
{ 0x00, 0x26, 0x42, 0x42, 0x4A, 0x3A, 0x24, 0x00 }, /*"3",19*/
{ 0x00, 0x08, 0x14, 0x24, 0x26, 0x7E, 0x00, 0x00 }, /*"4",20*/
{ 0x00, 0x36, 0x32, 0x32, 0x32, 0x32, 0x0C, 0x00 }, /*"5",21*/
{ 0x00, 0x3C, 0x2A, 0x52, 0x52, 0x32, 0x0C, 0x00 }, /*"6",22*/
{ 0x00, 0x20, 0x20, 0x26, 0x38, 0x20, 0x00, 0x00 }, /*"7",23*/
{ 0x00, 0x3E, 0x52, 0x52, 0x4A, 0x4A, 0x34, 0x00 }, /*"8",24*/
{ 0x00, 0x3A, 0x4A, 0x4A, 0x4A, 0x4A, 0x3C, 0x00 }, /*"9",25*/
{ 0x00, 0x00, 0x00, 0x12, 0x12, 0x00, 0x00, 0x00 }, /*":",26*/
{ 0x00, 0x00, 0x00, 0x13, 0x12, 0x00, 0x00, 0x00 }, /*";",27*/
{ 0x00, 0x00, 0x18, 0x14, 0x24, 0x22, 0x42, 0x00 }, /*"<",28*/
{ 0x00, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00 }, /*"=",29*/
{ 0x00, 0x42, 0x22, 0x24, 0x14, 0x18, 0x00, 0x00 }, /*">",30*/
{ 0x00, 0x20, 0x40, 0x46, 0x4A, 0x50, 0x30, 0x00 }, /*"?",31*/
{ 0x00, 0x3C, 0x2A, 0x56, 0x66, 0x3E, 0x26, 0x18 }, /*"@",32*/
{ 0x00, 0x06, 0x18, 0x28, 0x38, 0x0C, 0x02, 0x00 }, /*"A",33*/
{ 0x00, 0x3E, 0x2A, 0x2A, 0x2A, 0x32, 0x3E, 0x00 }, /*"B",34*/
{ 0x00, 0x3C, 0x22, 0x42, 0x42, 0x42, 0x42, 0x00 }, /*"C",35*/
{ 0x00, 0x3E, 0x22, 0x22, 0x22, 0x22, 0x3C, 0x00 }, /*"D",36*/
{ 0x00, 0x3E, 0x2A, 0x2A, 0x2A, 0x3A, 0x22, 0x00 }, /*"E",37*/
{ 0x00, 0x3E, 0x28, 0x28, 0x28, 0x28, 0x20, 0x20 }, /*"F",38*/
{ 0x08, 0x3C, 0x42, 0x42, 0x42, 0x42, 0x26, 0x00 }, /*"G",39*/
{ 0x00, 0x3E, 0x08, 0x08, 0x08, 0x08, 0x3E, 0x00 }, /*"H",40*/
{ 0x00, 0x00, 0x22, 0x3E, 0x3E, 0x22, 0x00, 0x00 }, /*"I",41*/
{ 0x00, 0x01, 0x01, 0x21, 0x21, 0x3E, 0x20, 0x00 }, /*"J",42*/
{ 0x00, 0x3E, 0x08, 0x10, 0x28, 0x24, 0x02, 0x00 }, /*"K",43*/
{ 0x00, 0x3E, 0x3E, 0x02, 0x02, 0x02, 0x02, 0x00 }, /*"L",44*/
{ 0x00, 0x3E, 0x18, 0x06, 0x08, 0x30, 0x3E, 0x00 }, /*"M",45*/
{ 0x00, 0x3E, 0x20, 0x10, 0x08, 0x04, 0x3E, 0x00 }, /*"N",46*/
{ 0x00, 0x3C, 0x42, 0x42, 0x42, 0x42, 0x3C, 0x08 }, /*"O",47*/
{ 0x00, 0x3E, 0x28, 0x28, 0x28, 0x28, 0x30, 0x00 }, /*"P",48*/
{ 0x00, 0x3C, 0x46, 0x46, 0x46, 0x43, 0x3D, 0x00 }, /*"Q",49*/
{ 0x00, 0x3E, 0x28, 0x28, 0x28, 0x34, 0x32, 0x00 }, /*"R",50*/
{ 0x00, 0x32, 0x52, 0x52, 0x4A, 0x4A, 0x24, 0x00 }, /*"S",51*/
{ 0x20, 0x20, 0x20, 0x3E, 0x22, 0x20, 0x20, 0x00 }, /*"T",52*/
{ 0x00, 0x3C, 0x02, 0x02, 0x02, 0x02, 0x3C, 0x00 }, /*"U",53*/
{ 0x00, 0x20, 0x18, 0x06, 0x0C, 0x10, 0x20, 0x00 }, /*"V",54*/
{ 0x00, 0x38, 0x06, 0x08, 0x38, 0x06, 0x38, 0x00 }, /*"W",55*/
{ 0x00, 0x02, 0x24, 0x18, 0x18, 0x24, 0x02, 0x00 }, /*"X",56*/
{ 0x00, 0x20, 0x30, 0x0E, 0x0A, 0x30, 0x20, 0x00 }, /*"Y",57*/
{ 0x00, 0x22, 0x26, 0x2A, 0x32, 0x22, 0x02, 0x00 }, /*"Z",58*/
{ 0x00, 0x00, 0x00, 0x7F, 0x41, 0x41, 0x01, 0x00 }, /*"[",59*/
{ 0x00, 0x40, 0x20, 0x10, 0x0C, 0x02, 0x01, 0x00 }, /*"\",60*/
{ 0x00, 0x01, 0x41, 0x41, 0x7F, 0x00, 0x00, 0x00 }, /*"]",61*/
{ 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00 }, /*"^",62*/
{ 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01 }, /*"_",63*/
{ 0x00, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00 }, /*"`",64*/
{ 0x00, 0x00, 0x00, 0x00, 0x18, 0x66, 0x01, 0x00 }, /*"{",65*/
{ 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00 }, /*"|",66*/
{ 0x00, 0x01, 0x66, 0x18, 0x00, 0x00, 0x00, 0x00 }, /*"}",67*/
{ 0x00, 0x80, 0x80, 0x80, 0x40, 0x40, 0x40, 0x00 }, /*"~",68*/

};

unsigned char NUM[]=
{

};

void write_i(unsigned char ins)
{
    W4_SCL_D_OUT;
    rt_pin_write(W4_DC_PIN, PIN_HIGH);  //DC=high;
//    DC = 0;
//    CS = 0;
//    WR = 1;
    W4_SDA_D_OUT;
    for(int i = 0; i < 8; i++)
    {
        if(ins & 0x80)
            rt_pin_write(W4_SDA_PIN, PIN_HIGH); //SDA=high;
        else
            rt_pin_write(W4_SDA_PIN, PIN_LOW);  //SDA=low;
        rt_hw_us_delay(W4C_DELAY);
//        rt_thread_delay(W4C_DELAY);
        rt_pin_write(W4_SCL_PIN, PIN_LOW);
        rt_hw_us_delay(W4C_DELAY);
//        rt_thread_delay(W4C_DELAY);
        rt_pin_write(W4_SCL_PIN, PIN_HIGH);
        rt_hw_us_delay(W4C_DELAY);
//        rt_thread_delay(W4C_DELAY);
        ins<<=1;
    }
//    P1 = ins;
//    WR = 0;
//    WR = 1;
//    CS = 1;
}

void write_d(unsigned char dat)
{
    W4_SCL_D_OUT;
    rt_pin_write(W4_DC_PIN, PIN_LOW);  //DC=low;
//    DC = 1;
//    CS = 0;
//    WR = 1;
    W4_SDA_D_OUT;
    for(int i = 0; i < 8; i++)
    {
        if(dat & 0x80)
            rt_pin_write(W4_SDA_PIN, PIN_HIGH); //SDA=high;
        else
            rt_pin_write(W4_SDA_PIN, PIN_LOW);  //SDA=low;
        rt_hw_us_delay(W4C_DELAY);
//        rt_thread_delay(W4C_DELAY);
        rt_pin_write(W4_SCL_PIN, PIN_LOW);
        rt_hw_us_delay(W4C_DELAY);
//        rt_thread_delay(W4C_DELAY);
        rt_pin_write(W4_SCL_PIN, PIN_HIGH);
        rt_hw_us_delay(W4C_DELAY);
//        rt_thread_delay(W4C_DELAY);
        dat<<=1;
    }
//    P1 = dat;
//    WR = 0;
//    WR = 1;
//    CS = 1;
}
void OLED_init(void)
{
    W4_OLED_D_OUT;
    W4_DC_D_OUT;
    W4_SCL_D_OUT;
    W4_SDA_D_OUT;
    rt_pin_write(W4_OLED_PIN, PIN_LOW);
    rt_pin_write(W4_DC_PIN, PIN_HIGH);
    rt_pin_write(W4_SCL_PIN, PIN_HIGH);
    rt_pin_write(W4_SDA_PIN, PIN_HIGH);
//    RES = 0;
//    rt_thread_delay(10);
//    RES = 1;
    rt_thread_mdelay(10);
    write_i(0xae); /* set display off */
    write_i(0x04); /* set lower column start address */
    write_i(0x10); /* set higher column start address */
    write_i(0x40); /* set display start line */
    write_i(0x81); /* set contrast control */
    write_i(0x80);
    write_i(0xa1); /* set segment remap */
    write_i(0xa6); /* set normal display */
    write_i(0xa8); /* set multiplex ratio */
    write_i(0x1f); /* 1/32 */
    write_i(0xc8); /* set com scan direction */
    write_i(0xd3); /* set display offset */
    write_i(0x00);
    write_i(0xd5); /* set display clock divide/oscillator frequency */
    write_i(0xf0);
    write_i(0xD8); /*set area color mode off */
    write_i(0x05);
    write_i(0xD9); /* Set Pre-Charge Period */
    write_i(0xC2);
    write_i(0xda); /* set com pin configuartion */
    write_i(0x12);
    write_i(0xdb); /* set Vcomh */
    write_i(0x08);
    rt_pin_write(W4_OLED_PIN, PIN_HIGH);
    rt_thread_mdelay(100);
    write_i(0xaf); /* set display on */
    rt_thread_mdelay(100);

}
void fill(unsigned char dat1, unsigned char dat2)
{
    unsigned char x, y;
    for (y = 0; y < 8; y++)
    {
        write_i(0xb0 + y);
        write_i(0x00);
        write_i(0x10);
        LOG_D("OLED fill In!");
        for (x = 0; x < 132; x++)
        {
            write_d(dat1);
            write_d(dat2);
        }
    }
}
void chinese(unsigned char page, unsigned char colum, unsigned int location)
{
    unsigned char i, j;
    j = location;
    write_i(0x00 | colum);
    write_i(0x10 | colum);
    write_i(0xb0 | page);
    LOG_D("OLED chinese In!");
    for (i = 0; i < 16; i++)
    {
        write_d(show[i][j++]);
    }
    write_i(0x00 | colum);
    write_i(0x10 | colum);
    write_i((0xb0 | page) + 1);
    for (i = 0; i < 16; i++)
    {
        write_d(show[i][j++]);
    }
}
void  oLED_test(int argc, char *argv[])
{
    OLED_init();
    LOG_D("OLED_init Pass!");
//    fill(0x55, 0x55);
//    rt_thread_mdelay(W4C_DELAY);
//    fill(0x55, 0xaa);
//    rt_thread_mdelay(W4C_DELAY);
//    fill(0x00, 0x00);
//    rt_thread_mdelay(W4C_DELAY);
//    write_i(0x4f);
//    rt_thread_mdelay(W4C_DELAY);
//
//    chinese(2, 0, 0);
//    chinese(2, 1, 32);
//    chinese(2, 2, 64);
//    chinese(2, 3, 96);
}

/* 导出到 msh 命令列表中 */
MSH_CMD_EXPORT(oLED_test, OLED_test sample);

